<?php
/**
 * get_shortcodes.php - FINÁLNÍ VERZE
 *
 * Tento skript definuje minimální potřebné funkce, aby se pluginy mohly načíst bez chyby,
 * a poté posbírá všechny zaregistrované shortcody.
 */

ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// KROK 1: Načtení základního nastavení a databázových funkcí
require_once '../config/config.php';
require_once '../functions/database.php';
require_once '../functions/shortcodes.php';

// KROK 2: Definice "falešných" funkcí, které pluginy očekávají
global $plugin_shortcodes;
$plugin_shortcodes = [];

if (!function_exists('register_activation_hook')) {
    function register_activation_hook($file, $callback) { /* Nedělá nic */ }
}

if (!function_exists('register_uninstall_hook')) {
    function register_uninstall_hook($file, $callback) { /* Nedělá nic */ }
}

// TOTO JE NOVÁ FUNKCE, KTEROU PŘIDÁVÁME
if (!function_exists('add_action')) {
    function add_action($tag, $callback) {
        /* V našem skriptu nedělá nic, jen zabrání pádu */
    }
}

if (!function_exists('add_shortcode')) {
    function add_shortcode($tag, $callback) {
        global $plugin_shortcodes;
        $plugin_shortcodes[$tag] = $callback;
    }
}

// KROK 3: Získání a načtení aktivních pluginů z databáze
try {
    $db = db_connect();
    $stmt = $db->query("SELECT plugin_folder FROM plugin_status WHERE is_active = 1");
    $active_plugins = $stmt->fetchAll(PDO::FETCH_ASSOC);

    if ($active_plugins) {
        foreach ($active_plugins as $plugin) {
            $plugin_path = '../plugins/' . $plugin['plugin_folder'] . '/plugin.php';
            if (file_exists($plugin_path)) {
                require_once $plugin_path;
            }
        }
    }

    // KROK 4: Sběr a odeslání dat
    $all_shortcodes = [];

    if (!empty($plugin_shortcodes)) {
        foreach ($plugin_shortcodes as $tag => $callback) {
            $all_shortcodes["[$tag]"] = "Plugin: $tag";
        }
    }

    $db_shortcodes = get_all_shortcodes();
    if ($db_shortcodes) {
        foreach ($db_shortcodes as $shortcode) {
            $tag = $shortcode['name'];
            $all_shortcodes["[$tag]"] = "Databáze: $tag";
        }
    }

    asort($all_shortcodes);

} catch (Exception $e) {
    http_response_code(500);
    $all_shortcodes = ['error' => 'Chyba při načítání shortcodů: ' . $e->getMessage()];
}

// Odstraníme dočasné zobrazení chyb před odesláním JSONu
ini_set('display_errors', 0);

header('Content-Type: application/json');
echo json_encode($all_shortcodes);
exit;