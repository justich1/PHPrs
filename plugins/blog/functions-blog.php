<?php
/**
 * Knihovna funkcí pro Blog plugin - KOMPLETNÍ VERZE S KOMENTÁŘI
 */

// ... (všechny stávající funkce od blog_ensure_db_tables až po blog_get_post_categories zůstávají stejné) ...
function blog_ensure_db_tables() { try { $db = db_connect(); $db->exec("CREATE TABLE IF NOT EXISTS `plugin_blog_posts` (`id` INT AUTO_INCREMENT PRIMARY KEY, `author_id` INT NULL, `allow_comments` TINYINT(1) NOT NULL DEFAULT 1, `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;"); $db->exec("CREATE TABLE IF NOT EXISTS `plugin_blog_posts_translations` (`id` INT AUTO_INCREMENT PRIMARY KEY, `post_id` INT NOT NULL, `lang_code` VARCHAR(5) NOT NULL, `title` VARCHAR(255) NOT NULL, `slug` VARCHAR(255) NOT NULL, `content` LONGTEXT NULL, `status` VARCHAR(20) NOT NULL DEFAULT 'draft', FOREIGN KEY (`post_id`) REFERENCES `plugin_blog_posts`(`id`) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;"); $db->exec("CREATE TABLE IF NOT EXISTS `plugin_blog_categories` (`id` INT AUTO_INCREMENT PRIMARY KEY,`created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;"); $db->exec("CREATE TABLE IF NOT EXISTS `plugin_blog_categories_translations` (`id` INT AUTO_INCREMENT PRIMARY KEY, `category_id` INT NOT NULL, `lang_code` VARCHAR(5) NOT NULL, `name` VARCHAR(255) NOT NULL, `slug` VARCHAR(255) NOT NULL, FOREIGN KEY (`category_id`) REFERENCES `plugin_blog_categories`(`id`) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;"); $db->exec("CREATE TABLE IF NOT EXISTS `plugin_blog_post_category_map` (`post_id` INT NOT NULL, `category_id` INT NOT NULL, PRIMARY KEY (`post_id`, `category_id`), FOREIGN KEY (`post_id`) REFERENCES `plugin_blog_posts`(`id`) ON DELETE CASCADE, FOREIGN KEY (`category_id`) REFERENCES `plugin_blog_categories`(`id`) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;"); $db->exec("CREATE TABLE IF NOT EXISTS `plugin_blog_comments` (`id` INT AUTO_INCREMENT PRIMARY KEY, `post_id` INT NOT NULL, `author_name` VARCHAR(100) NOT NULL, `author_email` VARCHAR(255) NOT NULL, `content` TEXT NOT NULL, `status` VARCHAR(20) NOT NULL DEFAULT 'pending', `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (`post_id`) REFERENCES `plugin_blog_posts`(`id`) ON DELETE CASCADE) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;"); } catch (PDOException $e) { die("Kritická chyba: Nepodařilo se vytvořit databázové tabulky pro Blog plugin. Chyba: " . $e->getMessage()); } }
function blog_drop_db_tables() { try { $db = db_connect(); $db->exec("DROP TABLE IF EXISTS `plugin_blog_comments`, `plugin_blog_post_category_map`, `plugin_blog_categories_translations`, `plugin_blog_categories`, `plugin_blog_posts_translations`, `plugin_blog_posts`;"); } catch (PDOException $e) {} }
function blog_save_post($data) { $db = db_connect(); $db->beginTransaction(); try { if (!empty($data['id'])) { $post_id = $data['id']; $stmt = $db->prepare("UPDATE plugin_blog_posts SET allow_comments = ? WHERE id = ?"); $stmt->execute([$data['allow_comments'], $post_id]); } else { $stmt = $db->prepare("INSERT INTO plugin_blog_posts (author_id, allow_comments) VALUES (?, ?)"); $stmt->execute([$data['author_id'], $data['allow_comments']]); $post_id = $db->lastInsertId(); } foreach ($data['translations'] as $lang_code => $translation) { if (empty($translation['title'])) continue; $stmt = $db->prepare("SELECT id FROM plugin_blog_posts_translations WHERE post_id = ? AND lang_code = ?"); $stmt->execute([$post_id, $lang_code]); if ($stmt->fetch()) { $stmt = $db->prepare("UPDATE plugin_blog_posts_translations SET title = ?, slug = ?, content = ?, status = ? WHERE post_id = ? AND lang_code = ?"); $stmt->execute([$translation['title'], $translation['slug'], $translation['content'], $data['status'], $post_id, $lang_code]); } else { $stmt = $db->prepare("INSERT INTO plugin_blog_posts_translations (post_id, lang_code, title, slug, content, status) VALUES (?, ?, ?, ?, ?, ?)"); $stmt->execute([$post_id, $lang_code, $translation['title'], $translation['slug'], $translation['content'], $data['status']]); } } $stmt = $db->prepare("DELETE FROM plugin_blog_post_category_map WHERE post_id = ?"); $stmt->execute([$post_id]); if (!empty($data['categories'])) { $stmt = $db->prepare("INSERT INTO plugin_blog_post_category_map (post_id, category_id) VALUES (?, ?)"); foreach ($data['categories'] as $cat_id) { $stmt->execute([$post_id, $cat_id]); } } $db->commit(); return $post_id; } catch (Exception $e) { $db->rollBack(); die("Chyba při ukládání článku: " . $e->getMessage()); } }
function blog_get_all_posts() { $db = db_connect(); $stmt = $db->prepare("SELECT p.id, p.created_at, t.title, t.status FROM plugin_blog_posts p LEFT JOIN plugin_blog_posts_translations t ON p.id = t.post_id AND t.lang_code = ? ORDER BY p.created_at DESC"); $stmt->execute([DEFAULT_LANG]); return $stmt->fetchAll(PDO::FETCH_ASSOC); }
function blog_get_post_details($id) { $db = db_connect(); $stmt = $db->prepare("SELECT * FROM plugin_blog_posts WHERE id = ?"); $stmt->execute([$id]); $post_base = $stmt->fetch(PDO::FETCH_ASSOC); if (!$post_base) return null; $post = ['id' => $post_base['id'], 'allow_comments' => $post_base['allow_comments']]; $stmt = $db->prepare("SELECT * FROM plugin_blog_posts_translations WHERE post_id = ?"); $stmt->execute([$id]); $translations = $stmt->fetchAll(PDO::FETCH_ASSOC); $post['translations'] = []; foreach ($translations as $t) { $post['translations'][$t['lang_code']] = $t; } $post['status'] = !empty($translations[0]['status']) ? $translations[0]['status'] : 'draft'; return $post; }
function blog_delete_post($id) { $db = db_connect(); $stmt = $db->prepare("DELETE FROM plugin_blog_posts WHERE id = ?"); return $stmt->execute([$id]); }
function blog_save_category($id, $translations) { $db = db_connect(); $db->beginTransaction(); try { if (!empty($id)) { $category_id = $id; } else { $db->exec("INSERT INTO plugin_blog_categories () VALUES ()"); $category_id = $db->lastInsertId(); } foreach ($translations as $lang_code => $t) { if (empty($t['name'])) continue; $stmt = $db->prepare("SELECT id FROM plugin_blog_categories_translations WHERE category_id = ? AND lang_code = ?"); $stmt->execute([$category_id, $lang_code]); if ($stmt->fetch()) { $stmt = $db->prepare("UPDATE plugin_blog_categories_translations SET name = ?, slug = ? WHERE category_id = ? AND lang_code = ?"); $stmt->execute([$t['name'], $t['slug'], $category_id, $lang_code]); } else { $stmt = $db->prepare("INSERT INTO plugin_blog_categories_translations (category_id, lang_code, name, slug) VALUES (?, ?, ?, ?)"); $stmt->execute([$category_id, $lang_code, $t['name'], $t['slug']]); } } $db->commit(); } catch (Exception $e) { $db->rollBack(); die("Chyba při ukládání kategorie: " . $e->getMessage()); } }
function blog_get_all_categories() { $db = db_connect(); $stmt = $db->prepare("SELECT c.id, t.name, t.slug FROM plugin_blog_categories c LEFT JOIN plugin_blog_categories_translations t ON c.id = t.category_id AND t.lang_code = ? ORDER BY t.name ASC"); $stmt->execute([DEFAULT_LANG]); return $stmt->fetchAll(PDO::FETCH_ASSOC); }
function blog_get_category_details($id) { $db = db_connect(); $stmt = $db->prepare("SELECT * FROM plugin_blog_categories_translations WHERE category_id = ?"); $stmt->execute([$id]); $translations = $stmt->fetchAll(PDO::FETCH_ASSOC); $category = ['id' => $id, 'translations' => []]; foreach ($translations as $t) { $category['translations'][$t['lang_code']] = $t; } return $category; }
function blog_delete_category($id) { $db = db_connect(); $stmt = $db->prepare("DELETE FROM plugin_blog_categories WHERE id = ?"); return $stmt->execute([$id]); }
function blog_get_post_categories($post_id) { $db = db_connect(); $stmt = $db->prepare("SELECT c.id, t.name, t.slug FROM plugin_blog_post_category_map m JOIN plugin_blog_categories c ON m.category_id = c.id JOIN plugin_blog_categories_translations t ON c.id = t.category_id WHERE m.post_id = ? AND t.lang_code = ?"); $stmt->execute([$post_id, DEFAULT_LANG]); return $stmt->fetchAll(PDO::FETCH_ASSOC); }

// --- NOVÉ/UPRAVENÉ FUNKCE PRO KOMENTÁŘE ---

function blog_get_all_comments_admin() {
    $db = db_connect();
    $stmt = $db->prepare("
        SELECT c.*, t.title as post_title
        FROM plugin_blog_comments c
        JOIN plugin_blog_posts_translations t ON c.post_id = t.post_id AND t.lang_code = ?
        ORDER BY c.created_at DESC
    ");
    $stmt->execute([DEFAULT_LANG]);
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

function blog_get_pending_comments_count() {
    $db = db_connect();
    $stmt = $db->query("SELECT COUNT(*) FROM plugin_blog_comments WHERE status = 'pending'");
    return $stmt->fetchColumn();
}

function blog_update_comment_status($comment_id, $status) {
    $db = db_connect();
    $stmt = $db->prepare("UPDATE plugin_blog_comments SET status = ? WHERE id = ?");
    return $stmt->execute([$status, $comment_id]);
}

function blog_delete_comment($comment_id) {
    $db = db_connect();
    $stmt = $db->prepare("DELETE FROM plugin_blog_comments WHERE id = ?");
    return $stmt->execute([$comment_id]);
}

// ... (zbytek funkcí pro frontend zůstává stejný) ...
function blog_get_published_posts($category_slug = null, $search_query = null) { $db = db_connect(); $params = [DEFAULT_LANG]; $sql = "SELECT p.id, t.title, t.slug, t.content, p.created_at FROM plugin_blog_posts p JOIN plugin_blog_posts_translations t ON p.id = t.post_id"; if ($category_slug) { $sql .= " JOIN plugin_blog_post_category_map m ON p.id = m.post_id JOIN plugin_blog_categories_translations ct ON m.category_id = ct.category_id "; } $sql .= " WHERE t.lang_code = ? AND t.status = 'published' "; if ($category_slug) { $sql .= " AND ct.slug = ? AND ct.lang_code = ? "; $params[] = $category_slug; $params[] = DEFAULT_LANG; } if ($search_query) { $sql .= " AND (t.title LIKE ? OR t.content LIKE ?) "; $params[] = '%' . $search_query . '%'; $params[] = '%' . $search_query . '%'; } $sql .= " ORDER BY p.created_at DESC"; $stmt = $db->prepare($sql); $stmt->execute($params); return $stmt->fetchAll(PDO::FETCH_ASSOC); }
function blog_get_post_by_slug($slug) { $db = db_connect(); $stmt = $db->prepare("SELECT p.id, p.allow_comments, t.title, t.content, p.created_at FROM plugin_blog_posts p JOIN plugin_blog_posts_translations t ON p.id = t.post_id WHERE t.slug = ? AND t.lang_code = ? AND t.status = 'published'"); $stmt->execute([$slug, DEFAULT_LANG]); return $stmt->fetch(PDO::FETCH_ASSOC); }
function blog_get_comments($post_id) { $db = db_connect(); $stmt = $db->prepare("SELECT * FROM plugin_blog_comments WHERE post_id = ? AND status = 'approved' ORDER BY created_at ASC"); $stmt->execute([$post_id]); return $stmt->fetchAll(PDO::FETCH_ASSOC); }
function blog_add_comment($post_id, $name, $email, $content) { $db = db_connect(); $stmt = $db->prepare("INSERT INTO plugin_blog_comments (post_id, author_name, author_email, content) VALUES (?, ?, ?, ?)"); return $stmt->execute([$post_id, $name, $email, $content]); }
function blog_render_shortcode() { if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'add_comment') { if (isset($_SESSION['client_user_id'])) { blog_add_comment($_POST['post_id'], $_SESSION['client_user_email'], $_SESSION['client_user_email'], $_POST['comment_content']); header("Location: " . $_SERVER['REQUEST_URI']); exit; } } $post_slug = $_GET['post'] ?? null; $category_slug = $_GET['category'] ?? null; $search_query = $_GET['search'] ?? null; ob_start(); ?> <style>.blog-container { max-width: 900px; margin: 0 auto; font-family: sans-serif; } .blog-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; } .blog-search form { display: flex; } .blog-search input { border: 1px solid #ccc; padding: 8px; border-radius: 4px 0 0 4px; } .blog-search button { border: 1px solid #007bff; background: #007bff; color: white; padding: 8px 12px; border-radius: 0 4px 4px 0; cursor: pointer; } .blog-categories a { margin-right: 15px; text-decoration: none; color: #555; } .blog-post-item { margin-bottom: 40px; } .blog-post-item h2 a { text-decoration: none; color: #333; } .blog-post-meta { font-size: 0.9em; color: #777; margin-bottom: 10px; } .blog-post-excerpt { color: #555; line-height: 1.6; } .blog-post-content { line-height: 1.7; } .comments-section { margin-top: 40px; border-top: 2px solid #f0f0f0; padding-top: 20px; } .comment { border-bottom: 1px solid #f0f0f0; padding: 15px 0; } .comment-author { font-weight: bold; } .comment-date { font-size: 0.8em; color: #888; } .comment-form textarea { width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; } .comment-form button { background: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }</style> <div class="blog-container"> <?php if ($post_slug): $post = blog_get_post_by_slug($post_slug); ?> <?php if ($post): ?> <a href="?">&larr; Zpět na výpis</a> <h1><?= htmlspecialchars($post['title']) ?></h1> <div class="blog-post-meta">Publikováno: <?= date('d. m. Y', strtotime($post['created_at'])) ?></div> <div class="blog-post-content"><?= $post['content'] ?></div> <?php if ($post['allow_comments']): ?> <div class="comments-section"> <h3>Komentáře</h3> <?php $comments = blog_get_comments($post['id']); ?> <?php if (empty($comments)): ?><p>Zatím zde nejsou žádné komentáře.</p><?php else: ?> <?php foreach ($comments as $comment): ?> <div class="comment"> <p class="comment-author"><?= htmlspecialchars($comment['author_name']) ?></p> <p class="comment-date"><?= date('d. m. Y H:i', strtotime($comment['created_at'])) ?></p> <p><?= nl2br(htmlspecialchars($comment['content'])) ?></p> </div> <?php endforeach; ?> <?php endif; ?> <?php if (isset($_SESSION['client_user_id'])): ?> <h4>Přidat komentář</h4> <form method="POST" action="" class="comment-form"> <input type="hidden" name="action" value="add_comment"><input type="hidden" name="post_id" value="<?= $post['id'] ?>"> <textarea name="comment_content" required placeholder="Napište svůj komentář..."></textarea> <button type="submit">Odeslat komentář</button> </form> <?php else: ?><p>Pro přidání komentáře se musíte <a href="/<?= user_get_setting('login_page_slug', 'prihlaseni') ?>">přihlásit</a>.</p><?php endif; ?> </div> <?php endif; ?> <?php else: ?><p>Článek nebyl nalezen.</p><?php endif; ?> <?php else: ?> <div class="blog-header"> <div class="blog-categories"> <a href="?">Všechny články</a> <?php $categories = blog_get_all_categories(); ?> <?php foreach ($categories as $cat): ?><a href="?category=<?= htmlspecialchars($cat['slug']) ?>"><?= htmlspecialchars($cat['name']) ?></a><?php endforeach; ?> </div> <div class="blog-search"> <form action="" method="GET"><input type="text" name="search" placeholder="Hledat..." value="<?= htmlspecialchars($search_query ?? '') ?>"><button type="submit">Hledat</button></form> </div> </div> <?php $posts = blog_get_published_posts($category_slug, $search_query); ?> <?php if (empty($posts)): ?><p>Nebyly nalezeny žádné články.</p><?php else: ?> <?php foreach ($posts as $post): ?> <div class="blog-post-item"> <h2><a href="?post=<?= htmlspecialchars($post['slug']) ?>"><?= htmlspecialchars($post['title']) ?></a></h2> <div class="blog-post-meta">Publikováno: <?= date('d. m. Y', strtotime($post['created_at'])) ?></div> <div class="blog-post-excerpt"><?= substr(strip_tags($post['content']), 0, 300) ?>... <a href="?post=<?= htmlspecialchars($post['slug']) ?>">Číst více</a></div> </div> <?php endforeach; ?> <?php endif; ?> <?php endif; ?> </div> <?php return ob_get_clean(); }
